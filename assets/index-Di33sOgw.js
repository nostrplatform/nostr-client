import{s as F,j as s,A as U,l as A,W as N,u as v,a as M,I as C,f as P,n as S,B as E,S as K}from"./index-BETSscnm.js";import{r as i,u as I,i as L}from"./react-stuff-BXf_FtOc.js";import{k as y,e as b,l as D}from"./nostr-dev-kit-Ci8rOtvv.js";import{F as W,S as z}from"./scroll-area-C4yQe26l.js";import{u as R}from"./index-B2SqHZ3w.js";import"./textarea-Wl9G6xb5.js";import"./zustand-B-hWnPoZ.js";const $=(t,r)=>{if(!r||!t)return 0;const e=t.toLowerCase().trim(),l=r.toLowerCase().trim();if(l===e)return 100;const o=l.split(/\s+/);if(o.includes(e))return 90;if(l.startsWith(e))return 80;if(l.includes(e))return 70;if(o.some(c=>c.startsWith(e)))return 60;let u=0,a=!0;for(const c of e){const d=l.indexOf(c,u);if(d===-1){a=!1;break}u=d+1}return a?40:0},O=i.memo(({pubkey:t,searchQuery:r})=>{var a,c;const{profile:e}=F(t),l=I(),o=i.useMemo(()=>new y({pubkey:t}).npub,[t]);return i.useMemo(()=>{var f,x,p,w;if(!(r!=null&&r.trim()))return!0;const m=[{text:(f=e==null?void 0:e.name)==null?void 0:f.toString(),weight:2},{text:(x=e==null?void 0:e.displayName)==null?void 0:x.toString(),weight:2},{text:(p=e==null?void 0:e.nip05)==null?void 0:p.toString(),weight:1.5},{text:o,weight:1},{text:t,weight:.8},{text:(w=e==null?void 0:e.about)==null?void 0:w.toString(),weight:.5}].map(n=>({score:$(r,n.text)*n.weight,text:n.text}));return Math.max(...m.map(n=>n.score))>=40},[e,o,t,r])?s.jsx(s.Fragment,{children:s.jsxs("div",{className:"px-4 py-2 flex items-center gap-2 hover:cursor-pointer hover:bg-secondary",onClick:()=>l(`/messages/${o}`),children:[s.jsx(U,{className:"bg-secondary",children:s.jsx(A,{src:(a=e==null?void 0:e.image)==null?void 0:a.toString(),alt:"profile-image",className:"object-cover"})}),s.jsxs("div",{className:"hidden md:block",children:[(e==null?void 0:e.name)&&s.jsx("div",{children:N(e.name.toString(),20)}),s.jsx("div",{className:"text-gray-500 text-sm",children:N(((c=e==null?void 0:e.nip05)==null?void 0:c.toString())||o,25)})]})]})}):null},(t,r)=>t.pubkey===r.pubkey&&t.searchQuery===r.searchQuery),B=i.memo(()=>{const[t,r]=i.useState(""),{activeUser:e}=v(),l=e?`messages-${e.pubkey}`:void 0,{createSubscription:o,events:u}=M(l);i.useEffect(()=>{e&&o({filters:[{kinds:[b.EncryptedDirectMessage],"#p":[e.pubkey]},{kinds:[b.EncryptedDirectMessage],authors:[e.pubkey]}]})},[e,o]);const a=i.useMemo(()=>{if(!u||u.length===0||!e)return[];const c=new Map;return u.forEach(d=>{var x;const m=d.pubkey===e.pubkey?(x=d.tags.find(p=>p[0]==="p"))==null?void 0:x[1]:d.pubkey;if(!m)return;const h=d.created_at||0,f=c.get(m)||0;h>f&&c.set(m,h)}),Array.from(c.entries()).sort(([,d],[,m])=>m-d).map(([d])=>d)},[u,e]);return s.jsxs("div",{className:"flex flex-col w-full h-full",children:[s.jsx("div",{className:"p-4 border-b hidden md:block",children:s.jsx(C,{type:"search",placeholder:"Search by name, npub or NIP-05...",value:t,onChange:c=>r(c.target.value),className:"w-full"})}),s.jsx("div",{className:"flex-1 overflow-y-auto overflow-x-hidden",children:a.map(c=>s.jsx(O,{pubkey:c,searchQuery:t},c))})]})}),T=i.memo(({chat:t,targetUser:r})=>{const[e,l]=i.useState(""),{activeUser:o}=v(),{ndk:u}=P();return i.useEffect(()=>{if(!u||!u.signer||!t.author||!t.content)return;const a=new D(u,t.rawEvent());a.decrypt(r).then(()=>{l(a.content)})},[u,t,l,r]),s.jsx(s.Fragment,{children:s.jsx("div",{className:S("flex gap-2",t.pubkey===(o==null?void 0:o.pubkey)?"justify-end":"justify-start"),children:s.jsx("div",{className:S("p-2 rounded-lg max-w-[80%]",t.pubkey===(o==null?void 0:o.pubkey)?"bg-purple-500/20 text-primary":"bg-secondary text-secondary-foreground"),children:s.jsx("p",{className:"[overflow-wrap:anywhere]",children:e})})})})},(t,r)=>t.chat.id===r.chat.id&&t.targetUser.pubkey===r.targetUser.pubkey),_=({user:t})=>{const r=I(),{profile:e}=R({pubkey:t.pubkey});return s.jsxs("div",{className:"p-4 border-b cursor-pointer flex items-center gap-3",onClick:()=>r(`/profile/${t.npub}`),children:[s.jsx("img",{src:(e==null?void 0:e.image)||"https://www.gravatar.com/avatar/00000000000000000000000000000000?d=mp&f=y",alt:"Profile",className:"w-12 h-12 rounded-full object-cover",onError:l=>{l.currentTarget.src="https://www.gravatar.com/avatar/00000000000000000000000000000000?d=mp&f=y"}}),s.jsxs("div",{className:"min-w-0 flex-1",children:[s.jsx("div",{className:"font-medium",children:(e==null?void 0:e.displayName)||(e==null?void 0:e.name)||t.npub.slice(0,8)+"..."}),(e==null?void 0:e.about)&&s.jsx("div",{className:"text-sm text-gray-500 truncate max-w-full",children:e.about})]})]})},H=i.memo(({npub:t})=>{const[r,e]=i.useState(""),l=i.useRef(null),[o,u]=i.useState(!1),{activeUser:a}=v(),{ndk:c}=P(),d=a?`messages-${a.pubkey}`:void 0,{createSubscription:m,events:h}=M(d);i.useEffect(()=>{a&&m({filters:[{kinds:[b.EncryptedDirectMessage],"#p":[a.pubkey]},{kinds:[b.EncryptedDirectMessage],authors:[a.pubkey]}]})},[a,m]);const f=i.useMemo(()=>new y({npub:t}),[t]),x=i.useMemo(()=>{if(!a)return[];if(!h||h.length===0)return[];const n=f.pubkey;return(h??[]).filter(g=>g.pubkey===n||g.tags.some(j=>j[0]==="p"&&j[1]===n))},[h,f,a]);i.useEffect(()=>{var n;(n=l.current)==null||n.scrollIntoView({behavior:"smooth"})},[x]);const p=i.useCallback(async()=>{var k;if(!c||!a)return;const n=new y({npub:t}),g=await((k=c.signer)==null?void 0:k.encrypt(n,r,"nip04"));if(!g)return;const j=new D(c);j.kind=b.EncryptedDirectMessage,j.content=g,j.tags=[["p",n.pubkey]],j.publish(),e("")},[c,a,r,t,e]),w=n=>{e(g=>g+n.emoji),u(!1)};return s.jsx(s.Fragment,{children:s.jsxs("div",{className:"w-full h-full overflow-hidden flex flex-col justify-between",children:[s.jsx(_,{user:f}),s.jsxs("div",{className:"flex flex-col gap-4 overflow-y-auto h-full w-full p-4",children:[(x||[]).map(n=>s.jsx(T,{chat:n,targetUser:f},n.id)),s.jsx("div",{ref:l})]}),s.jsxs("div",{className:"flex items-center gap-2 border-t p-4",children:[s.jsx(W,{isOpen:o,onClose:()=>u(!1),onEmojiClick:w,variant:"compact",position:"top",children:s.jsx(E,{variant:"ghost",size:"icon",onClick:()=>u(!o),className:"h-10 w-10",children:s.jsx(z,{size:18})})}),s.jsx(C,{type:"text",value:r,onChange:n=>e(n.target.value),className:"w-full",onKeyDown:n=>{n.key==="Enter"&&r.trim()&&(n.preventDefault(),p())}}),s.jsx(E,{onClick:p,disabled:!r,children:"Send"})]})]})})},(t,r)=>t.npub===r.npub),V=i.memo(({npub:t})=>s.jsx(s.Fragment,{children:s.jsxs("div",{className:"flex overflow-hidden w-full h-full",children:[s.jsx("div",{className:"max-w-72 shrink-0 border-r overflow-y-hidden h-full",children:s.jsx(B,{})}),s.jsx("div",{className:"w-full h-full overflow-hidden",children:t&&s.jsx(H,{npub:t})})]})}),(t,r)=>t.npub===r.npub),ee=()=>{const{npub:t}=L(),{activeUser:r}=v();return r===void 0?s.jsx(K,{}):r===null?s.jsx("div",{className:"flex flex-col h-full w-full items-center justify-center",children:s.jsx("h3",{children:"Welcome to Nostr Platform!"})}):s.jsx(s.Fragment,{children:s.jsx("div",{className:"h-full w-full",children:s.jsx(V,{npub:t})})})};export{ee as MessagesPage};
